@page "/"

<PageTitle>FlySight Webtool</PageTitle>

@using FlySightWebTool.Data
@using System.Text

@inject TrackService TrackService
@inject IJSRuntime JS

<div id="plotlyChart" style="width:100%; height:400px;"></div>

@if (track == null)
{
    <h1>Track</h1>
    <p><InputFile OnChange="HandleFileSelected" accept=".csv" /></p>
    <p><em>@message</em></p>
}
else
{
    <h3>@track.TakeOffDateTime.ToString("HH:mm (d MMMM yyyy)")</h3>

    <table class="table">
        <tbody>            
            <tr>
                <th>Exit</th>
                <td>@track.ExitHeight.ToString("F0")m AGL at @track.ExitDateTime.ToString("HH:mm")</td>
            </tr>
            <tr>
                <th>Pitch</th>
                <td>@track.PitchHeight.ToString("F0")m AGL at @track.PitchDateTime.ToString("HH:mm")</td>
            </tr>
            <tr>
                <th>Landing</th>
                <td>@track.LandingTime.ToString("HH:mm")</td>
            </tr>
            <tr>
                <th>Flight time</th>
                <td>@track.FlightTime.ToString("F0")s over @((track.ExitAltitude - track.PitchAltitude).ToString("F0"))m</td>
            </tr>
            <tr>
                <th>Total time</th>
                <td>@((track.LandingTime - track.TakeOffDateTime).TotalMinutes.ToString("F0"))min
                </td>            
            </tr>
            <tr>
                <th>DZ Elevation offset</th>
                <td>@track.DzAltitude.ToString("F0")m AMSL</td>
            </tr>
        </tbody>
    </table>
}

@code {
    private Track? track;
    private string message = "";

    protected override async Task OnInitializedAsync()
    {
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        message = "Reading file..."; //Reading file
        this.StateHasChanged();

        var file = e.File;

        if (file == null) 
            throw new Exception($"File object is null");

        StringBuilder fileContent = new StringBuilder();

        try
        {
            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10MB

            using var reader = new StreamReader(stream);

            char[] buffer = new char[8192]; // 8 KB buffer
            int bytesRead;

            while ((bytesRead = await reader.ReadAsync(buffer, 0, buffer.Length)) > 0)
            {
                fileContent.Append(buffer, 0, bytesRead);
            }

            message = "Computing..."; //Calculating
            this.StateHasChanged();

            track = await TrackService.LoadTrackFromFileAsync(fileContent.ToString());

            if (track.Data.Count == 0)
            {
                message = "No data";
                this.StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            throw new Exception($"Error reading file: {file.Name}, {ex.Message}");
        }        
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {

        }
        else
        {
            if (track == null || track.Data.Count == 0)
                return;

            var plotlyDatasource = new PlotlyDatasource(track);
            var data = plotlyDatasource.getData();
            var layout = plotlyDatasource.getLayout();

            await JS.InvokeVoidAsync("plotlyInterop.createChart", "plotlyChart", data, layout);
        }
    }
}